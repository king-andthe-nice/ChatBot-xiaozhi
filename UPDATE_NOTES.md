# 小智语音助手更新说明

## 2025年3月更新

在本次更新中，我们解决了两个关键问题：

### 1. MQTT连接自动断开问题

**问题描述：** 之前版本中，应用程序会在大约30秒无活动后自动断开MQTT连接，需要用户重新连接。

**解决方案：** 
- 将MQTT客户端的`keepalive`参数从默认值(60秒)修改为120秒(2分钟)
- 这将使连接在较长时间内保持活跃，减少自动断开的频率

**技术细节：**
- MQTT协议使用"Keep Alive"机制维持连接
- 如果在指定的时间内没有通信，客户端需发送PING请求
- 延长这个时间可以减少不必要的连接重置

### 2. 多用户混乱问题

**问题描述：** 当多人使用同一个可执行文件时，所有用户共享相同的设备ID，导致：
- 用户A的连接被用户B顶掉
- 界面上反复显示"连接服务器成功"消息
- 各用户之间的会话相互干扰

**解决方案：**
- 使用用户设备的实际MAC地址作为唯一标识符
- 确保每台计算机都有自己独立的设备ID
- 保留通过环境变量强制使用固定ID的选项

**技术细节：**
- 优先使用网卡的物理MAC地址
- 采用多种备用方法确保在任何环境下都能获取到唯一标识
- 如果无法获取物理MAC，则基于用户名和计算机名生成稳定的唯一ID
- 保留`XIAOZHI_FIXED_MAC`环境变量开关

## 如何使用

### 普通用户

- 直接使用更新后的应用程序
- 第一次使用时可能需要进行设备验证（一次性操作）
- 连接将保持更长时间而不断开

### 高级用户

如果需要使用固定的设备ID（不推荐多用户共享时使用）：

1. 设置环境变量：
   ```
   set XIAOZHI_FIXED_MAC=1
   ```

2. 然后运行应用程序：
   ```
   xiaozhi-voice-assistant.exe
   ```

## 首次使用设备验证

首次使用该应用程序时，服务器可能会要求验证设备：

1. 程序会显示类似"请登录到控制面板添加设备，输入验证码: XXXXXX"的提示
2. 这是一种安全措施，确保只有授权设备可以连接到服务
3. 您需要联系管理员或访问以下网址进行验证：
   - 网址：https://控制台地址 (请向管理员咨询具体地址)
   - 登录后，在"设备管理"部分添加新设备并输入验证码
4. 验证成功后，您的设备ID将被记录在服务器中，以后使用不再需要验证

## 常见问题

**Q: 显示需要输入验证码，但不知道在哪里输入?**  
A: 这是服务器的安全机制，需要在控制台网站进行验证。请联系您的管理员获取控制台访问地址和账号。

**Q: 我设置了XIAOZHI_FIXED_MAC=1但依然生成新ID?**  
A: 确保在运行应用程序的同一命令窗口中设置了环境变量。

**Q: 连接仍然会断开?**  
A: 即使设置了较长的keepalive时间，如果网络不稳定或长时间没有交互，连接仍可能断开。这是正常的网络行为，应用会自动尝试重连。 